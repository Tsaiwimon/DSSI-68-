{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ตะกร้าสินค้า | Glam & Borrow</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="bg-gradient-to-r from-pink-200 via-yellow-100 to-blue-200 shadow w-full">
  <div class="w-full px-8 py-9 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ตะกร้าสินค้า ({{ cart_items.count }})</h1>
    <div class="flex items-center gap-4">
      <a href="{% url 'dress:member_home' %}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">
        ← กลับหน้าหลัก
      </a>
      <button id="edit-btn" class="bg-white text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-100 transition">
        แก้ไข
      </button>
    </div>
  </div>
</header>

<!-- Main -->
<main class="max-w-6xl mx-auto py-8 px-6">
  {% for shop, data in grouped_cart.items %}
    <div class="mb-6 bg-white-50 rounded-lg shadow p-4 shop-group"
         data-shop="{{ shop.name }}"
         data-shop-id="{{ shop.id }}"
         data-shop-closed="{% if data.shop_closed %}1{% else %}0{% endif %}">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">{{ shop.name }} <span class="text-gray-500">></span></h2>

        {% if data.shop_closed %}
          <span class="text-xs font-semibold px-3 py-1 rounded-full bg-yellow-50 border border-yellow-200 text-yellow-800">
            ร้านปิดชั่วคราว
          </span>
        {% else %}
          <span class="text-xs font-semibold px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-700">
            เปิดให้บริการ
          </span>
        {% endif %}
      </div>

      {% for item in data.items %}
        <div class="flex items-center justify-between border-b py-3 item-row" data-item-id="{{ item.id }}">
          <div class="flex items-start gap-4">
            <!-- Checkbox (ใช้เลือก ลบ/ย้าย/ชำระเงิน) -->
            <input
              type="checkbox"
              class="edit-checkbox hidden w-5 h-5 accent-pink-500"
              data-id="{{ item.id }}"
              data-store-id="{{ shop.id }}"
            >

            <!-- รูป -->
            <a href="{% url 'dress:dress_detail' item.dress.id %}"
               class="transition transform hover:scale-105 hover:shadow-lg cursor-pointer rounded-lg">
              {% if item.dress.image %}
                <img src="{{ item.dress.image.url }}" alt="{{ item.dress.name }}" class="w-20 h-24 object-cover rounded-lg">
              {% else %}
                <img src="{% static 'images/placeholder-4x3.jpg' %}" alt="{{ item.dress.name }}" class="w-20 h-24 object-cover rounded-lg">
              {% endif %}
            </a>

            <!-- ข้อมูลสินค้า -->
            <div>
              <a href="{% url 'dress:dress_detail' item.dress.id %}"
                 class="font-medium text-gray-800 hover:text-pink-600 transition cursor-pointer">
                {{ item.dress.name }}
              </a>

              <p><span class="font-semibold">ขนาด:</span> {{ item.dress.size|default:"-" }}</p>
              <p class="text-sm text-gray-600 mt-1">จำนวน: <span class="font-semibold">1</span> ชุด</p>

              <a href="{% url 'dress:dress_detail' item.dress.id %}"
                 class="inline-block mt-1 bg-pink-100 text-pink-600 px-3 py-1 rounded hover:bg-pink-200 transition text-xs font-medium">
                ดูรายละเอียด
              </a>

              {% if data.shop_closed %}
                <div class="mt-2 text-xs text-yellow-800 bg-yellow-50 border border-yellow-200 px-3 py-2 rounded">
                  ร้านปิดชั่วคราว — ยังไม่สามารถชำระเงินสินค้าร้านนี้ได้
                </div>
              {% endif %}
            </div>
          </div>

          <!-- ราคา/วัน (เช่า 1 ชุดต่อรายการ) -->
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500">ราคา/วัน</span>
            <p class="font-semibold text-pink-600 item-total" data-price="{{ item.dress.daily_price }}">
              ฿{{ item.dress.daily_price|floatformat:2 }}
            </p>
          </div>
        </div>
      {% endfor %}

      <!-- รวมร้าน (ราคา/วัน) -->
      <div class="mt-3 flex justify-end items-center">
        <p class="font-semibold text-pink-700 shop-total">
          รวมร้าน {{ shop.name }}: ฿{{ data.total|floatformat:2 }}
        </p>
      </div>
    </div>
  {% empty %}
    <p class="text-center text-gray-500 mt-10">ยังไม่มีสินค้าในตะกร้า</p>
  {% endfor %}

  <!-- ปุ่มโหมดแก้ไข -->
  <div id="edit-actions" class="hidden mt-8 text-right space-x-3">
    <button id="delete-selected" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
      ลบที่เลือก
    </button>
    <button id="move-favorite" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
      ย้ายไปสินค้าที่ถูกใจ
    </button>
    <button id="cancel-edit" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
      ยกเลิก
    </button>
  </div>

  <!-- รวมทั้งหมด -->
  <div class="mt-10 flex justify-between items-center border-t pt-6">
    <div></div>
    <div class="text-right">
      <p class="text-lg text-gray-600">
        ยอดรวมตามที่เลือก (ราคา/วัน):
        <span id="selected-total" class="font-bold text-pink-600">฿0.00</span>
      </p>

      <button id="checkout-btn"
              data-checkout-url="{% url 'dress:cart_checkout' %}"
              class="mt-2 bg-blue-600 text-white px-8 py-2 rounded hover:bg-blue-700">
        ชำระเงิน
      </button>
      <p id="checkout-hint" class="text-xs text-gray-500 mt-2 hidden">
        * ร้านปิดชั่วคราว — ไม่สามารถชำระเงินได้
      </p>
    </div>
  </div>
</main>

<!-- Modal: เลือกได้แค่ร้านเดียว (ตอนกดชำระเงินเท่านั้น) -->
<div id="storeLimitModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black bg-opacity-40"></div>

  <div class="relative bg-white w-full max-w-md rounded-xl shadow-lg p-6">
    <h3 class="text-lg font-semibold text-gray-800">แจ้งเตือน</h3>
    <p class="text-sm text-gray-600 mt-2">
      เลือกชำระเงินได้เฉพาะสินค้าที่อยู่ร้านเดียวกันเท่านั้น
    </p>

    <div class="mt-5 flex justify-end">
      <button id="closeStoreLimitModal"
        class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">
        ตกลง
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const editBtn = document.getElementById("edit-btn");
  const editActions = document.getElementById("edit-actions");
  const checkboxes = document.querySelectorAll(".edit-checkbox");
  const cancelBtn = document.getElementById("cancel-edit");
  const deleteBtn = document.getElementById("delete-selected");
  const moveBtn = document.getElementById("move-favorite");
  const totalText = document.getElementById("selected-total");
  const checkoutBtn = document.getElementById("checkout-btn");
  const checkoutHint = document.getElementById("checkout-hint");

  let editMode = false;

  // ===== Modal เปิด/ปิด =====
  const modal = document.getElementById("storeLimitModal");
  const closeModalBtn = document.getElementById("closeStoreLimitModal");

  function openModal() {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeModal() {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  closeModalBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // ===== csrf =====
  const csrfToken = document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || "";

  // ===== toggle โหมดแก้ไข (แสดง checkbox) =====
  editBtn.addEventListener("click", () => {
    editMode = !editMode;
    checkboxes.forEach(cb => cb.classList.toggle("hidden", !editMode));
    editActions.classList.toggle("hidden", !editMode);
    editBtn.textContent = editMode ? "กลับ" : "แก้ไข";
    updateSelectedTotal();
  });

  // ===== ยกเลิก =====
  cancelBtn.addEventListener("click", () => {
    editMode = false;
    checkboxes.forEach(cb => { cb.checked = false; cb.classList.add("hidden"); });
    editActions.classList.add("hidden");
    editBtn.textContent = "แก้ไข";
    updateSelectedTotal();
  });

  // ===== คำนวณรวมร้าน (ราคา/วัน) =====
  function recalcAllTotals() {
    document.querySelectorAll(".shop-group").forEach(shop => {
      let shopTotal = 0;

      shop.querySelectorAll(".item-row").forEach(item => {
        const price = parseFloat(item.querySelector(".item-total").dataset.price || "0");
        const qty = 1;
        shopTotal += (price * qty);
      });

      const shopTotalNode = shop.querySelector(".shop-total");
      if (shopTotalNode) {
        shopTotalNode.textContent = "รวมร้าน " + shop.dataset.shop + ": ฿" + shopTotal.toFixed(2);
      }
    });
  }

  // ===== ยอดรวมตามที่เลือก (ราคา/วัน) + ปิดปุ่มชำระเงินถ้าร้านปิด =====
  function updateSelectedTotal() {
    let selectedTotal = 0;
    const checked = Array.from(checkboxes).filter(cb => cb.checked);

    checked.forEach(cb => {
      const row = cb.closest(".item-row");
      if (!row) return;

      const price = parseFloat(row.querySelector(".item-total").dataset.price || "0");
      const qty = 1;
      selectedTotal += price * qty;
    });

    totalText.textContent = "฿" + selectedTotal.toFixed(2);

    // === disable checkout ถ้าเลือกร้านปิด ===
    let disableCheckout = false;

    if (checked.length) {
      const storeId = checked[0].dataset.storeId;
      const shopGroup = document.querySelector(`.shop-group[data-shop-id="${storeId}"]`);
      disableCheckout = shopGroup?.dataset.shopClosed === "1";
    }

    checkoutBtn.disabled = disableCheckout;

    if (disableCheckout) {
      checkoutBtn.classList.remove("bg-blue-600", "hover:bg-blue-700", "text-white");
      checkoutBtn.classList.add("bg-gray-300", "text-gray-700", "cursor-not-allowed");
      checkoutHint.classList.remove("hidden");
    } else {
      checkoutBtn.classList.remove("bg-gray-300", "text-gray-700", "cursor-not-allowed");
      checkoutBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "text-white");
      checkoutHint.classList.add("hidden");
    }
  }

  checkboxes.forEach(cb => cb.addEventListener("change", updateSelectedTotal));

  // ===== Utilities: selected ids / stores =====
  function getSelectedIds() {
    return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.id);
  }

  function getSelectedStores() {
    const stores = new Set();
    Array.from(checkboxes).filter(cb => cb.checked).forEach(cb => {
      stores.add(cb.dataset.storeId);
    });
    return stores;
  }

  // ===== กดชำระเงิน: เช็คร้านเดียวกัน + เช็คร้านปิด =====
  checkoutBtn.addEventListener("click", () => {
    const selectedIds = getSelectedIds();

    if (!selectedIds.length) {
      alert("กรุณาเลือกสินค้าที่ต้องการชำระเงิน");
      return;
    }

    const stores = getSelectedStores();
    if (stores.size > 1) {
      openModal();
      return;
    }

    // เช็คร้านปิด
    const selectedStoreId = Array.from(stores)[0];
    const shopGroup = document.querySelector(`.shop-group[data-shop-id="${selectedStoreId}"]`);
    const shopClosed = shopGroup?.dataset.shopClosed === "1";
    if (shopClosed) {
      alert("ร้านปิดชั่วคราว — ไม่สามารถชำระเงินได้ตอนนี้");
      return;
    }

    const checkoutUrl = checkoutBtn.dataset.checkoutUrl;
    const qs = selectedIds.map(id => `ids=${encodeURIComponent(id)}`).join("&");
    window.location.href = `${checkoutUrl}?${qs}`;
  });

  // ===== ลบที่เลือก =====
  deleteBtn.addEventListener("click", () => {
    const selectedIds = getSelectedIds();
    if (!selectedIds.length) return alert("กรุณาเลือกสินค้าที่ต้องการลบ");
    if (!confirm("ต้องการลบสินค้าที่เลือกหรือไม่?")) return;

    fetch("/cart/remove_bulk/", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify({ ids: selectedIds })
    }).then(() => location.reload());
  });

  // ===== ย้ายไปถูกใจ =====
  moveBtn.addEventListener("click", () => {
    const selectedIds = getSelectedIds();
    if (!selectedIds.length) return alert("กรุณาเลือกสินค้าที่ต้องการย้ายไปถูกใจ");

    fetch("/cart/move_to_favorite/", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify({ ids: selectedIds })
    }).then(() => location.reload());
  });

  // เริ่มต้น
  recalcAllTotals();
  updateSelectedTotal();
});
</script>

</body>
</html>
