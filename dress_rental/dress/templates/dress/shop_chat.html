{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แชทสอบถามข้อมูลร้าน</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<header class="bg-gradient-to-r from-pink-200 via-yellow-100 to-blue-200 shadow w-full">
  <div class="w-full px-10 py-8 flex justify-between items-center">
    <div class="flex items-center gap-3">
      {% if shop_obj.shop_logo %}
        <img src="{{ shop_obj.shop_logo.url }}" class="w-10 h-10 rounded-full object-cover" alt="logo">
      {% endif %}
      <div>
        <h1 class="text-xl font-semibold text-gray-800">แชทสอบถามข้อมูลร้าน</h1>
        <p class="text-sm text-gray-600">
          คุยกับร้าน: {{ shop_obj.name }}
        </p>
      </div>
    </div>

    <!-- ปุ่มย้อนกลับ: ถ้ามีหน้าก่อนหน้าให้ back, ถ้าไม่มีกลับไป member_home -->
    <a href="javascript:void(0);"
       onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href='{% url "dress:member_home" %}'; }"
       class="bg-white text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-100 transition">
      ← ย้อนกลับ
    </a>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8">

  <div id="chatBox"
       class="bg-white rounded-3xl shadow border border-gray-100 h-[520px] overflow-y-auto px-6 py-6">
    {% if messages %}
      {% for m in messages %}
        {% if m.sender_id == request.user.id %}
          <!-- ลูกค้าส่ง (ขวา) -->
          <div class="flex justify-end mb-3">
            <div class="max-w-xs bg-blue-500 text-white rounded-2xl px-4 py-2 text-sm">
              {% if m.message %}
                <p class="whitespace-pre-line">{{ m.message }}</p>
              {% endif %}
              {% if m.image %}
                <img src="{{ m.image.url }}" class="mt-2 rounded-xl border border-blue-100">
              {% endif %}
              <p class="text-[11px] text-blue-100 mt-1 text-right">
                {{ m.created_at|date:"Y-m-d H:i" }}
              </p>
            </div>
          </div>
        {% else %}
          <!-- ร้านส่ง (ซ้าย) -->
          <div class="flex justify-start mb-3">
            <div class="max-w-xs bg-gray-100 text-gray-800 rounded-2xl px-4 py-2 text-sm">
              {% if m.message %}
                <p class="whitespace-pre-line">{{ m.message }}</p>
              {% endif %}
              {% if m.image %}
                <img src="{{ m.image.url }}" class="mt-2 rounded-xl border border-gray-200">
              {% endif %}
              <p class="text-[11px] text-gray-400 mt-1">
                {{ m.created_at|date:"Y-m-d H:i" }}
              </p>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="text-center text-gray-400 mt-10">
        ยังไม่มีข้อความ เริ่มต้นสนทนาได้เลย
      </p>
    {% endif %}
  </div>

  <!-- แถวส่งข้อความ -->
  <div class="mt-4">
    <div class="flex items-center gap-2 border-t border-gray-200 pt-4">
      <!-- ปุ่มอัปโหลดรูป เป็นไอคอนกล้อง -->
      <label for="imageInput"
             class="flex items-center justify-center w-10 h-10 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 7h4l2-3h6l2 3h4v12H3V7z" />
          <circle cx="12" cy="13" r="4" stroke-width="2" stroke="currentColor" fill="none" />
        </svg>
        <span class="sr-only">เลือกรูปภาพ</span>
      </label>

      <input id="imageInput" name="image" type="file" accept="image/*" class="hidden">

      <form id="chatForm" class="flex-1 flex items-center gap-3">
        {% csrf_token %}
        <textarea id="messageInput"
                  name="message"
                  rows="1"
                  placeholder="พิมพ์ข้อความสอบถามร้าน..."
                  class="flex-1 resize-none border border-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400"></textarea>

        <button type="submit"
                class="min-w-[56px] px-4 py-2 bg-pink-500 text-white text-sm rounded-full hover:bg-pink-600">
          ส่ง
        </button>
      </form>
    </div>
  </div>

</main>

<script>
  const chatBox = document.getElementById("chatBox");
  const form = document.getElementById("chatForm");
  const input = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  const csrfToken = document.querySelector("input[name=csrfmiddlewaretoken]").value;

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  scrollToBottom();

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const text = input.value.trim();
    const file = imageInput.files[0];

    if (!text && !file) {
      return;
    }

    const formData = new FormData();
    formData.append("message", text);
    if (file) {
      formData.append("image", file);
    }

    fetch("{% url 'dress:shop_chat_send' shop_obj.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
      },
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.error) {
          console.error(data.error);
          return;
        }

        const wrapper = document.createElement("div");
        wrapper.className = "flex justify-end mb-3";

        const bubble = document.createElement("div");
        bubble.className = "max-w-xs bg-blue-500 text-white rounded-2xl px-4 py-2 text-sm";

        if (data.message) {
          const p = document.createElement("p");
          p.className = "whitespace-pre-line";
          p.textContent = data.message;
          bubble.appendChild(p);
        }

        if (data.image_url) {
          const img = document.createElement("img");
          img.src = data.image_url;
          img.className = "mt-2 rounded-xl border border-blue-100";
          bubble.appendChild(img);
        }

        const time = document.createElement("p");
        time.className = "text-[11px] text-blue-100 mt-1 text-right";
        time.textContent = data.created_at;
        bubble.appendChild(time);

        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);

        input.value = "";
        imageInput.value = "";
        scrollToBottom();
      })
      .catch((err) => console.error(err));
  });
</script>

</body>
</html>
