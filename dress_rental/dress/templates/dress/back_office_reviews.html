{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>รีวิวจากลูกค้า | {{ store.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-gradient-to-r from-pink-200 via-yellow-100 to-blue-200 shadow w-full">
    <div class="flex items-center justify-between px-10 py-10">
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold text-gray-900">ระบบหลังร้าน</h1>
      </div>

      <div class="flex items-center space-x-3">
        {% if store.shop_logo %}
          <img src="{{ store.shop_logo.url }}" alt="logo" class="w-12 h-12 rounded-full object-cover">
        {% else %}
          <img src="{% static 'images/store-placeholder.png' %}" alt="logo" class="w-12 h-12 rounded-full object-cover">
        {% endif %}
        <span class="font-semibold text-lg">{{ store.name }}</span>
      </div>
    </div>
  </header>

  <!-- Tabs บนสุด (เหมือนหน้าอื่น) -->
  <div class="flex justify-center space-x-3 bg-white shadow py-3 px-4 border-t border-gray-100">
    <a href="{% url 'dress:my_store' store.id %}"
       class="flex-1 text-center py-3 rounded-lg border font-semibold hover:bg-gray-100 transition">
      หน้าร้าน
    </a>
    <a href="{% url 'dress:store_dress' store.id %}"
       class="flex-1 text-center py-3 rounded-lg border font-semibold hover:bg-gray-100 transition">
      รายการสินค้า
    </a>
    <a href="{% url 'dress:back_office' store.id %}"
       class="flex-1 text-center py-3 rounded-lg bg-black text-white font-semibold hover:bg-gray-800 transition">
      หลังร้าน
    </a>
  </div>

  <!-- ปุ่มกลับหลังร้าน -->
  <section class="max-w-6xl mx-auto px-6 pt-6">
    <div class="flex justify-end">
      <a href="{% url 'dress:back_office' store.id %}"
         class="px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-50 transition">
        ← ย้อนกลับหลังร้าน
      </a>
    </div>
  </section>

  <!-- เนื้อหาหลัก -->
  <main class="max-w-6xl mx-auto px-6 py-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-1">รีวิวจากลูกค้า</h2>
    <p class="text-sm text-gray-500 mb-6">
      รีวิวทั้งหมดของชุดในร้าน {{ store.name }}
    </p>

    {% if reviews %}
      <div class="space-y-4">
        {% for review in reviews %}
          <article class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 flex gap-4">

            <!-- รูปชุด -->
            <div class="w-24 h-32 flex-shrink-0 rounded-xl overflow-hidden bg-gray-100">
              {% if review.dress.image %}
                <img src="{{ review.dress.image.url }}" alt="{{ review.dress.name }}" class="w-full h-full object-cover">
              {% else %}
                <div class="w-full h-full flex items-center justify-center text-xs text-gray-400">
                  ไม่มีรูป
                </div>
              {% endif %}
            </div>

            <!-- ข้อมูลรีวิว -->
            <div class="flex-1">
              <div class="flex justify-between items-start gap-4">
                <div>
                  <h3 class="font-semibold text-base text-gray-900">
                    {{ review.dress.name }}
                  </h3>
                  <p class="text-xs text-gray-500 mt-1">
                    โดย {{ review.user.username }} · {{ review.created_at|date:"d/m/Y H:i" }}
                  </p>
                  <p class="mt-2 text-sm text-gray-800">
                    {{ review.comment }}
                  </p>

                  {% if review.shop_reply %}
                    <!-- แสดงคำตอบจากร้านในหลังร้านด้วย -->
                    <div class="mt-3 pl-4 border-l-2 border-blue-200">
                      <div class="text-xs font-semibold text-blue-600 mb-1">
                        คำตอบจากร้าน (ตอบกลับแล้ว)
                      </div>
                      <p class="text-sm text-gray-800">
                        {{ review.shop_reply }}
                      </p>
                      {% if review.replied_at %}
                        <p class="text-[11px] text-gray-400 mt-1">
                          อัปเดตล่าสุดเมื่อ {{ review.replied_at|date:"d/m/Y H:i" }}
                        </p>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>

                <!-- คะแนน + สถานะตอบแล้ว -->
                <div class="text-right space-y-2">
                  <div class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-50 border border-yellow-200">
                    <span class="text-sm font-semibold text-yellow-700">
                      {{ review.rating }}/5
                    </span>
                  </div>

                  {% if review.shop_reply %}
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-green-50 border border-green-200">
                      <span class="text-xs font-semibold text-green-700">
                        ตอบกลับรีวิวแล้ว
                      </span>
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- ปุ่ม: ดูหน้าสินค้า / ตอบกลับรีวิว -->
              <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
                <div class="text-xs text-gray-400">
                  รหัสชุด: #{{ review.dress.id }}
                </div>

                <div class="flex gap-2">
                  <!-- ปุ่มดูหน้าสินค้า -->
                  <a href="{% url 'dress:dress_detail' review.dress.id %}"
                     target="_blank"
                     class="px-4 py-2 text-xs font-medium rounded-lg border border-gray-300 text-gray-800 hover:bg-gray-50 transition">
                    ดูหน้าสินค้า
                  </a>

                  <!-- ปุ่มแสดงกล่องตอบกลับ -->
                  <button type="button"
                          onclick="document.getElementById('reply-box-{{ review.id }}').classList.toggle('hidden');"
                          class="px-4 py-2 text-xs font-medium rounded-lg border border-blue-500 text-blue-600 hover:bg-blue-50 transition">
                    ตอบกลับรีวิว
                  </button>
                </div>
              </div>

              <!-- กล่องตอบกลับรีวิว -->
              <div id="reply-box-{{ review.id }}"
                   class="mt-4 bg-gray-50 rounded-xl p-4 border border-gray-200 {% if not review.shop_reply %}hidden{% endif %}">
                <form method="post" class="space-y-2">
                  {% csrf_token %}
                  <input type="hidden" name="review_id" value="{{ review.id }}">

                  <label class="block text-xs font-semibold text-gray-700 mb-1">
                    คำตอบจากร้าน
                  </label>

                  <textarea name="reply"
                            rows="2"
                            class="w-full text-sm border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            placeholder="พิมพ์คำตอบถึงลูกค้า...">{{ review.shop_reply }}</textarea>

                  <div class="flex justify-end mt-2">
                    <button type="submit"
                            class="px-4 py-2 text-xs font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
                      บันทึกคำตอบ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <!-- ยังไม่มีรีวิว -->
      <section class="flex flex-col items-center justify-center py-20 text-gray-500">
        <p class="font-medium">ยังไม่มีรีวิวจากลูกค้า</p>
        <p class="text-xs text-gray-400 mt-1">
          เมื่อมีลูกค้าให้คะแนนและเขียนรีวิว จะปรากฏให้คุณจัดการที่นี่
        </p>
      </section>
    {% endif %}
  </main>

</body>
</html>
