{% extends "backoffice/base.html" %}

{% block title %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% endblock %}
{% block page_title %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% endblock %}
{% block page_subtitle %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow border border-black/5 overflow-hidden">

  <!-- Header + Filters -->
  <div class="p-6 border-b">
    <div class="flex items-start justify-between gap-6">
      <div>
        <div class="text-lg font-semibold text-neutral-900">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="text-sm text-neutral-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ total_filtered }} ‡∏Ñ‡∏ô</div>
      </div>
    </div>

    <form method="get" class="mt-5 flex flex-wrap items-center gap-3">
      <!-- Search -->
      <div class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2 w-full md:w-[380px]">
        <span class="text-neutral-400">üîç</span>
        <input type="text" name="q" value="{{ q }}" placeholder="Search users.." class="w-full outline-none text-sm" />
      </div>

      <!-- Role -->
      <select name="role" class="border rounded-xl px-4 py-2 text-sm w-full md:w-[180px]">
        <option value="" {% if role == "" %}selected{% endif %}>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
        <option value="admin" {% if role == "admin" %}selected{% endif %}>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</option>
        <option value="shop" {% if role == "shop" %}selected{% endif %}>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option value="user" {% if role == "user" %}selected{% endif %}>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
      </select>

      <!-- Status -->
      <select name="status" class="border rounded-xl px-4 py-2 text-sm w-full md:w-[180px]">
        <option value="" {% if status == "" %}selected{% endif %}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
        <option value="active" {% if status == "active" %}selected{% endif %}>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</option>
        <option value="inactive" {% if status == "inactive" %}selected{% endif %}>‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
      </select>

      <button type="submit" class="px-5 py-2 rounded-xl bg-neutral-900 text-white text-sm font-semibold hover:bg-black">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <a href="{% url 'backoffice:users' %}" class="px-5 py-2 rounded-xl bg-neutral-100 text-sm font-semibold hover:bg-neutral-200">‡∏•‡πâ‡∏≤‡∏á</a>
    </form>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-neutral-50 text-neutral-600">
        <tr>
          <th class="text-left font-medium px-6 py-4">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="text-left font-medium px-6 py-4">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
          <th class="text-left font-medium px-6 py-4">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
          <th class="text-left font-medium px-6 py-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="text-left font-medium px-6 py-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
          <th class="text-right font-medium px-6 py-4"></th>
        </tr>
      </thead>

      <tbody class="divide-y">
        {% for u in page_obj %}
        <tr class="hover:bg-neutral-50">
          <!-- Name -->
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-full bg-neutral-200 flex items-center justify-center font-semibold text-neutral-700">
                {{ u.username|default:"U"|slice:":1"|upper }}
              </div>
              <div>
                <div class="font-semibold text-neutral-900">{{ u.username|default:"-" }}</div>
                <div class="text-xs text-neutral-500">ID: {{ u.id }}</div>
              </div>
            </div>
          </td>

          <!-- Email -->
          <td class="px-6 py-4 text-neutral-700">{{ u.email|default:"-" }}</td>

          <!-- Role -->
          <td class="px-6 py-4">
            {% if u.is_superuser or u.is_staff %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-purple-50 text-purple-700 text-xs font-semibold border border-purple-100">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
            {% elif u.is_shop_owner %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-semibold border border-amber-100">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-neutral-100 text-neutral-700 text-xs font-semibold border border-neutral-200">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
            {% endif %}
          </td>

          <!-- Status -->
          <td class="px-6 py-4">
            {% if u.is_active %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold border border-emerald-100">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-red-50 text-red-700 text-xs font-semibold border border-red-100">‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</span>
            {% endif %}
          </td>

          <!-- Joined -->
          <td class="px-6 py-4 text-neutral-700">{{ u.date_joined|date:"d/m/Y" }}</td>

          <!-- Actions -->
          <td class="px-6 py-4 text-right relative">
            <button type="button" class="px-2 py-1 rounded-lg hover:bg-neutral-200" onclick="toggleMenu('m{{ u.id }}')">‚ãÆ</button>

            <div id="m{{ u.id }}" class="hidden absolute right-6 mt-2 w-48 bg-white border rounded-xl shadow-lg overflow-hidden z-20">
              <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-neutral-50 text-neutral-400 cursor-not-allowed" title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>

              {% if u.is_active %}
                <form method="post" action="{% url 'backoffice:user_suspend' u.id %}" class="js-confirm-form"
                      data-action="suspend" data-username="{{ u.username|default:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="w-full text-left px-4 py-2 text-sm hover:bg-neutral-50">‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </form>
              {% else %}
                <form method="post" action="{% url 'backoffice:user_activate' u.id %}" class="js-confirm-form"
                      data-action="activate" data-username="{{ u.username|default:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="w-full text-left px-4 py-2 text-sm hover:bg-neutral-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>
                </form>
              {% endif %}

              <form method="post" action="{% url 'backoffice:user_delete' u.id %}" class="js-confirm-form"
                    data-action="delete" data-username="{{ u.username|default:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="w-full text-left px-4 py-2 text-sm hover:bg-neutral-50 text-red-600">‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-6 py-10 text-center text-neutral-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="p-6 flex items-center justify-between">
    <div class="text-sm text-neutral-500">‡∏´‡∏ô‡πâ‡∏≤ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</div>

    <div class="flex items-center gap-2">
      {% if page_obj.has_previous %}
        <a class="px-3 py-2 rounded-lg border hover:bg-neutral-50"
           href="?{% if preserved_qs %}{{ preserved_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
      {% else %}
        <span class="px-3 py-2 rounded-lg border text-neutral-300">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
      {% endif %}

      <span class="px-3 py-2 rounded-lg bg-neutral-900 text-white">{{ page_obj.number }}</span>

      {% if page_obj.has_next %}
        <a class="px-3 py-2 rounded-lg border hover:bg-neutral-50"
           href="?{% if preserved_qs %}{{ preserved_qs }}&{% endif %}page={{ page_obj.next_page_number }}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
      {% else %}
        <span class="px-3 py-2 rounded-lg border text-neutral-300">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- Professional Confirm Modal -->
<div id="confirmModal" class="hidden fixed inset-0 z-[999]">
  <div class="absolute inset-0 bg-black/40"></div>

  <div class="relative min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl border border-black/10 overflow-hidden">
      <div class="p-5 flex items-start gap-3">
        <div id="cmIcon" class="h-10 w-10 rounded-xl flex items-center justify-center bg-neutral-100 text-neutral-700">!</div>
        <div class="flex-1">
          <div id="cmTitle" class="text-lg font-semibold text-neutral-900">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          <div id="cmDesc" class="text-sm text-neutral-600 mt-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        </div>
        <button type="button" class="p-2 rounded-lg hover:bg-neutral-100" onclick="closeConfirm()">
          ‚úï
        </button>
      </div>

      <div class="px-5 pb-5">
        <div id="cmHint" class="text-xs text-neutral-500 bg-neutral-50 border border-black/5 rounded-xl p-3">
          ‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
        </div>

        <div class="mt-4 flex items-center justify-end gap-2">
          <button type="button" class="px-4 py-2 rounded-xl bg-neutral-100 hover:bg-neutral-200 text-sm font-semibold"
                  onclick="closeConfirm()">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button id="cmConfirmBtn" type="button"
                  class="px-4 py-2 rounded-xl text-white text-sm font-semibold bg-neutral-900 hover:bg-black">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Dropdown menu
  function toggleMenu(id) {
    const el = document.getElementById(id);
    if (!el) return;

    document.querySelectorAll('[id^="m"]').forEach(x => {
      if (x.id !== id) x.classList.add('hidden');
    });

    el.classList.toggle('hidden');
  }

  document.addEventListener('click', function(e){
    const isMenuBtn = e.target.closest('button[onclick^="toggleMenu"]');
    const isMenuBox = e.target.closest('[id^="m"]');
    if (!isMenuBtn && !isMenuBox) {
      document.querySelectorAll('[id^="m"]').forEach(x => x.classList.add('hidden'));
    }
  });

  // Confirm modal logic
  const modal = document.getElementById('confirmModal');
  const cmTitle = document.getElementById('cmTitle');
  const cmDesc = document.getElementById('cmDesc');
  const cmIcon = document.getElementById('cmIcon');
  const cmConfirmBtn = document.getElementById('cmConfirmBtn');

  let pendingForm = null;

  function openConfirm({action, username, form}) {
    pendingForm = form;

    // theme by action
    if (action === 'delete') {
      cmTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      cmDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ`;
      cmIcon.className = 'h-10 w-10 rounded-xl flex items-center justify-center bg-red-50 text-red-700';
      cmIcon.textContent = 'üóë';
      cmConfirmBtn.className = 'px-4 py-2 rounded-xl text-white text-sm font-semibold bg-red-600 hover:bg-red-700';
      cmConfirmBtn.textContent = '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
    } else if (action === 'suspend') {
      cmTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      cmDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö`;
      cmIcon.className = 'h-10 w-10 rounded-xl flex items-center justify-center bg-amber-50 text-amber-700';
      cmIcon.textContent = '‚õî';
      cmConfirmBtn.className = 'px-4 py-2 rounded-xl text-white text-sm font-semibold bg-neutral-900 hover:bg-black';
      cmConfirmBtn.textContent = '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
    } else if (action === 'activate') {
      cmTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö';
      cmDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ`;
      cmIcon.className = 'h-10 w-10 rounded-xl flex items-center justify-center bg-emerald-50 text-emerald-700';
      cmIcon.textContent = '‚úÖ';
      cmConfirmBtn.className = 'px-4 py-2 rounded-xl text-white text-sm font-semibold bg-emerald-600 hover:bg-emerald-700';
      cmConfirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    } else {
      cmTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      cmDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö "${username}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`;
      cmIcon.className = 'h-10 w-10 rounded-xl flex items-center justify-center bg-neutral-100 text-neutral-700';
      cmIcon.textContent = '!';
      cmConfirmBtn.className = 'px-4 py-2 rounded-xl text-white text-sm font-semibold bg-neutral-900 hover:bg-black';
      cmConfirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    }

    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeConfirm() {
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    pendingForm = null;
  }

  // close when click overlay
  modal.addEventListener('click', (e) => {
    if (e.target === modal || e.target.classList.contains('bg-black/40')) closeConfirm();
  });

  // bind forms
  document.querySelectorAll('.js-confirm-form').forEach((form) => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const action = form.dataset.action || '';
      const username = form.dataset.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      openConfirm({action, username, form});
    });
  });

  // confirm button actually submit
  cmConfirmBtn.addEventListener('click', () => {
    if (pendingForm) pendingForm.submit();
  });

  // ESC close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeConfirm();
  });
</script>
{% endblock %}
