{% extends "backoffice/base.html" %}

{% block title %}รีวิว{% endblock %}
{% block page_title %}รีวิวทั้งหมด{% endblock %}
{% block page_subtitle %}จัดการรีวิวจากผู้ใช้ (ดึงข้อมูลจริงจากระบบ){% endblock %}

{% block content %}
<div class="space-y-5">

  <!-- Summary -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-white rounded-2xl shadow border border-black/5 p-5">
      <div class="text-3xl font-extrabold text-neutral-900">{{ total_count }}</div>
      <div class="text-sm text-neutral-500 mt-1">รีวิวทั้งหมด (ตามตัวกรอง)</div>
    </div>

    <div class="bg-white rounded-2xl shadow border border-black/5 p-5">
      <div class="text-3xl font-extrabold text-neutral-900">{{ rating5_count }}</div>
      <div class="text-sm text-neutral-500 mt-1">5 ดาว</div>
    </div>

    <div class="bg-white rounded-2xl shadow border border-black/5 p-5">
      <div class="text-3xl font-extrabold text-neutral-900">{{ rating4_count }}</div>
      <div class="text-sm text-neutral-500 mt-1">4 ดาว</div>
    </div>

    <div class="bg-white rounded-2xl shadow border border-black/5 p-5">
      <div class="text-3xl font-extrabold text-neutral-900">{{ pending_reply_count }}</div>
      <div class="text-sm text-neutral-500 mt-1">ยังไม่ตอบกลับ</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-2xl shadow border border-black/5 overflow-hidden">
    <div class="p-6 border-b">
      <form method="get" class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">

        <!-- Search -->
        <div class="lg:col-span-5 flex items-center gap-2 bg-white border rounded-xl px-3 py-2">
          <span class="text-neutral-400">ค้นหา</span>
          <input
            type="text"
            name="q"
            value="{{ q }}"
            placeholder="ชื่อผู้ใช้ / ร้าน / ชุด / คอมเมนต์..."
            class="w-full outline-none text-sm"
          />
        </div>

        <!-- Rating -->
        <select name="rating" class="lg:col-span-2 border rounded-xl px-4 py-2 text-sm">
          <option value="all" {% if rating == "all" %}selected{% endif %}>ดาวทั้งหมด</option>
          <option value="5" {% if rating == "5" %}selected{% endif %}>5 ดาว</option>
          <option value="4" {% if rating == "4" %}selected{% endif %}>4 ดาว</option>
          <option value="3" {% if rating == "3" %}selected{% endif %}>3 ดาว</option>
          <option value="2" {% if rating == "2" %}selected{% endif %}>2 ดาว</option>
          <option value="1" {% if rating == "1" %}selected{% endif %}>1 ดาว</option>
        </select>

        <!-- Shop -->
        <select name="shop" class="lg:col-span-2 border rounded-xl px-4 py-2 text-sm">
          <option value="all" {% if shop_id == "all" %}selected{% endif %}>ร้านทั้งหมด</option>
          {% for s in shops %}
            <option value="{{ s.id }}" {% if shop_id|add:"0" == s.id %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>

        <!-- Replied -->
        <select name="replied" class="lg:col-span-1 border rounded-xl px-4 py-2 text-sm">
          <option value="all" {% if replied == "all" %}selected{% endif %}>ตอบกลับ</option>
          <option value="yes" {% if replied == "yes" %}selected{% endif %}>ตอบแล้ว</option>
          <option value="no" {% if replied == "no" %}selected{% endif %}>ยังไม่ตอบ</option>
        </select>

        <!-- Has image -->
        <select name="has_image" class="lg:col-span-1 border rounded-xl px-4 py-2 text-sm">
          <option value="all" {% if has_image == "all" %}selected{% endif %}>รูป</option>
          <option value="yes" {% if has_image == "yes" %}selected{% endif %}>มีรูป</option>
          <option value="no" {% if has_image == "no" %}selected{% endif %}>ไม่มีรูป</option>
        </select>

        <!-- Sort -->
        <select name="sort" class="lg:col-span-1 border rounded-xl px-4 py-2 text-sm">
          <option value="new" {% if sort == "new" %}selected{% endif %}>ใหม่สุด</option>
          <option value="old" {% if sort == "old" %}selected{% endif %}>เก่าสุด</option>
          <option value="rating_high" {% if sort == "rating_high" %}selected{% endif %}>ดาวมาก→น้อย</option>
          <option value="rating_low" {% if sort == "rating_low" %}selected{% endif %}>ดาวน้อย→มาก</option>
        </select>

        <div class="lg:col-span-12 flex items-center gap-2 justify-end">
          <button type="submit" class="px-6 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
            ค้นหา
          </button>
          <a href="{% url 'backoffice:reviews' %}" class="px-6 py-2 rounded-xl bg-neutral-100 text-sm font-semibold hover:bg-neutral-200">
            ล้าง
          </a>
        </div>
      </form>
    </div>

    <!-- List -->
    <div class="p-6 space-y-4">
      {% for r in page_obj %}
      <div class="bg-white border border-black/10 rounded-2xl shadow-sm p-5">
        <div class="flex items-start justify-between gap-4">
          <div class="flex items-start gap-4">
            <!-- Avatar -->
            <div class="h-10 w-10 rounded-full bg-neutral-200 flex items-center justify-center font-semibold text-neutral-700">
              {{ r.user.username|default:"U"|slice:":1"|upper }}
            </div>

            <div class="space-y-1">
              <div class="flex items-center gap-3 flex-wrap">
                <div class="font-semibold text-neutral-900">
                  {{ r.user.username|default:r.user.email|default:"ผู้ใช้" }}
                </div>
                <div class="text-xs text-neutral-500">
                  {{ r.created_at|date:"d M Y" }}
                </div>
              </div>

              <!-- Stars + Shop -->
              <div class="flex items-center gap-3 flex-wrap">
                <div class="flex items-center gap-1">
                  {% for i in star_range %}
                    {% if i <= r.rating %}
                      <span class="text-yellow-400">★</span>
                    {% else %}
                      <span class="text-neutral-300">★</span>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="text-sm text-neutral-600">
                  ร้าน: <span class="font-medium">{{ r.dress.shop.name }}</span>
                </div>
                <div class="text-sm text-neutral-600">
                  ชุด: <span class="font-medium">{{ r.dress.name }}</span>
                </div>

                {% if r.shop_reply %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold border border-emerald-100">
                    ตอบกลับแล้ว
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-semibold border border-amber-100">
                    ยังไม่ตอบกลับ
                  </span>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-2">
            <!-- Delete (custom modal) -->
            <form method="post" class="js-delete-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="review_id" value="{{ r.id }}">
              <button
                type="button"
                class="js-open-delete px-4 py-2 rounded-xl bg-rose-500 text-white text-sm font-semibold hover:bg-rose-600"
                data-username="{{ r.user.username|default:r.user.email|default:'ผู้ใช้' }}"
                data-shop="{{ r.dress.shop.name }}"
                data-dress="{{ r.dress.name }}"
                data-rating="{{ r.rating }}"
              >
                ลบ
              </button>
            </form>
          </div>
        </div>

        <!-- Comment -->
        <div class="mt-4 text-neutral-800 leading-relaxed">
          {{ r.comment|default:"(ไม่มีข้อความ)" }}
        </div>

        <!-- Image -->
        {% if r.image %}
          <div class="mt-4">
            <img src="{{ r.image.url }}" alt="review image" class="max-h-48 rounded-xl border">
          </div>
        {% endif %}

        <!-- Reply box -->
        <div class="mt-5 border-t pt-4">
          <details class="group">
            <summary class="cursor-pointer text-sm font-semibold text-blue-600 hover:text-blue-700">
              ตอบกลับรีวิว
            </summary>
            <div class="mt-3 space-y-2">
              {% if r.shop_reply %}
                <div class="text-sm text-neutral-600">
                  ตอบล่าสุด: <span class="font-medium">{{ r.replied_at|date:"d/m/Y H:i" }}</span>
                </div>
                <div class="bg-neutral-50 border rounded-xl p-3 text-sm text-neutral-800">
                  {{ r.shop_reply }}
                </div>
              {% endif %}

              <form method="post" class="space-y-2">
                {% csrf_token %}
                <input type="hidden" name="action" value="reply">
                <input type="hidden" name="review_id" value="{{ r.id }}">
                <textarea
                  name="reply_text"
                  rows="3"
                  class="w-full border rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-200"
                  placeholder="พิมพ์ข้อความตอบกลับจากแอดมิน/ร้าน..."
                >{{ r.shop_reply }}</textarea>

                <button class="px-5 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
                  บันทึกการตอบกลับ
                </button>
              </form>
            </div>
          </details>
        </div>
      </div>
      {% empty %}
      <div class="py-16 text-center text-neutral-500">
        ยังไม่มีรีวิวในระบบ (0 รายการ)
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="px-6 pb-6 flex items-center justify-between">
      <div class="text-sm text-neutral-500">
        หน้า {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
      </div>

      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="px-3 py-2 rounded-lg border hover:bg-neutral-50"
             href="?q={{ q }}&rating={{ rating }}&shop={{ shop_id }}&replied={{ replied }}&has_image={{ has_image }}&sort={{ sort }}&page={{ page_obj.previous_page_number }}">
            ก่อนหน้า
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-lg border text-neutral-300">ก่อนหน้า</span>
        {% endif %}

        <span class="px-3 py-2 rounded-lg bg-neutral-900 text-white">
          {{ page_obj.number }}
        </span>

        {% if page_obj.has_next %}
          <a class="px-3 py-2 rounded-lg border hover:bg-neutral-50"
             href="?q={{ q }}&rating={{ rating }}&shop={{ shop_id }}&replied={{ replied }}&has_image={{ has_image }}&sort={{ sort }}&page={{ page_obj.next_page_number }}">
            ถัดไป
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-lg border text-neutral-300">ถัดไป</span>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<!-- Delete Confirm Modal -->
<div id="deleteModal" class="fixed inset-0 z-[9999] hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40"></div>

  <!-- Dialog -->
  <div class="relative min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-black/10 overflow-hidden">
      <div class="p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-lg font-extrabold text-neutral-900">ยืนยันการลบรีวิว</div>
            <div class="text-sm text-neutral-500 mt-1">ลบแล้วกู้คืนไม่ได้ แน่ใจนะ?</div>
          </div>
          <button type="button" class="js-close-delete text-neutral-400 hover:text-neutral-700">
            ✕
          </button>
        </div>

        <div class="mt-4 bg-neutral-50 border rounded-xl p-4 text-sm text-neutral-800 space-y-1">
          <div><span class="text-neutral-500">ผู้ใช้:</span> <span class="font-semibold" id="dmUser">-</span></div>
          <div><span class="text-neutral-500">ร้าน:</span> <span class="font-semibold" id="dmShop">-</span></div>
          <div><span class="text-neutral-500">ชุด:</span> <span class="font-semibold" id="dmDress">-</span></div>
          <div><span class="text-neutral-500">ดาว:</span> <span class="font-semibold" id="dmRating">-</span></div>
        </div>

        <div class="mt-5 flex items-center justify-end gap-2">
          <button type="button" class="js-close-delete px-4 py-2 rounded-xl bg-neutral-100 text-sm font-semibold hover:bg-neutral-200">
            ยกเลิก
          </button>
          <button type="button" id="dmConfirm" class="px-4 py-2 rounded-xl bg-rose-600 text-white text-sm font-semibold hover:bg-rose-700">
            ยืนยันลบ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const modal = document.getElementById('deleteModal');
  const btnConfirm = document.getElementById('dmConfirm');
  const dmUser = document.getElementById('dmUser');
  const dmShop = document.getElementById('dmShop');
  const dmDress = document.getElementById('dmDress');
  const dmRating = document.getElementById('dmRating');

  let targetForm = null;

  function openModal({ user, shop, dress, rating, form }) {
    targetForm = form;
    dmUser.textContent = user || '-';
    dmShop.textContent = shop || '-';
    dmDress.textContent = dress || '-';
    dmRating.textContent = rating ? `${rating} ดาว` : '-';
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    targetForm = null;
  }

  // Open buttons
  document.querySelectorAll('.js-open-delete').forEach((btn) => {
    btn.addEventListener('click', () => {
      const form = btn.closest('form');
      openModal({
        user: btn.dataset.username,
        shop: btn.dataset.shop,
        dress: btn.dataset.dress,
        rating: btn.dataset.rating,
        form: form
      });
    });
  });

  // Close buttons
  document.querySelectorAll('.js-close-delete').forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Click backdrop to close
  modal.addEventListener('click', (e) => {
    if (e.target === modal || e.target.classList.contains('bg-black/40')) {
      closeModal();
    }
  });

  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (!modal.classList.contains('hidden') && e.key === 'Escape') {
      closeModal();
    }
  });

  // Confirm delete
  btnConfirm.addEventListener('click', () => {
    if (targetForm) targetForm.submit();
  });
})();
</script>
{% endblock %}
